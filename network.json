{
  "AWSTemplateFormatVersion" : "2010-09-09",
  
  "Description" : "DevopsFactory VPC Stack. Provisions: Internet Gateway, VPN Gateway, WindowsSecurityGroup, LinuxSecurityGroup",
  
  "Parameters" : {
    "Type" : {
      "Type" : "String",
      "Description" : "Type",
      "Default" : "NonProduction",
      "AllowedValues" : ["Production", "NonProduction" ],
      "ConstraintDescription" : "Specify the type of VPC to provision e.g. NonProduction."
    },    
    "VPCCIDRBlock": {
      "Type": "String",
      "Description": "The CIDR block for the VPC", 
      "AllowedPattern": "\\d{1,3}+\\.\\d{1,3}+\\.\\d{1,3}+\\.\\d{1,3}/\\d\\d", 
      "ConstraintDescription": "Must be a valid CIDR IP address xx.xx.xx.xx/xx",       
      "MaxLength": "18", 
      "MinLength": "1" 
    }    
  },    
  "Conditions" : {
    "ShouldCreateProdResources" : {"Fn::Equals" : [{"Ref" : "Type"}, "Production"]}
  },  
  "Resources": {  
    "VPC" : {
      "Type" : "AWS::EC2::VPC",
      "Properties" : {
        "CidrBlock" : { "Ref" : "VPCCIDRBlock" },
        "Tags" : [
          {"Key" : "Name", "Value" : { "Ref" : "AWS::StackName"} }          
        ]
      }
    },                
    "InternetGateway" : {
      "Type" : "AWS::EC2::InternetGateway",
      "Properties" : {
        "Tags" : [
          { "Key" : "Name", "Value" : { "Fn::Join" : [ "", [ { "Ref" : "AWS::StackName"}, "InternetGateway"] ]} },
          { "Key" : "Application", "Value" : { "Ref" : "AWS::StackName"} },
          { "Key" : "Network", "Value" : "Public" }
        ]
      }
    },    
    "AttachInternetGateway" : {
      "Type" : "AWS::EC2::VPCGatewayAttachment",
      "Properties" : {
        "VpcId" : { "Ref" : "VPC" },
        "InternetGatewayId" : { "Ref" : "InternetGateway" }
      }
    },    
    "VPNGateway" : {
      "Type" : "AWS::EC2::VPNGateway",
      "Properties" : {
        "Type" : "ipsec.1",
        "Tags" : [          
          { "Key" : "Name", "Value" : { "Fn::Join" : [ "", [ { "Ref" : "AWS::StackName"}, "VPNGateway"] ]} }
        ]        
      }      
    },    
    "AttachVPNGateway" : {
      "Type" : "AWS::EC2::VPCGatewayAttachment",
      "Properties" : {
        "VpcId" : { "Ref" : "VPC" },
        "VpnGatewayId" : { "Ref" : "VPNGateway" }
      }
    },                          
    "SecurityGroupWindowsServer" : {
      "Type" : "AWS::EC2::SecurityGroup",
      "Properties" : {
        "GroupDescription" : "Provides administrator access to Windows hosts",
        "VpcId" : {"Ref" : "VPC"},
        "Tags" : [
          { "Key" : "Name", "Value" : { "Fn::Join" : [ "", [ "SEC-", { "Ref" : "AWS::StackName"}, "-WindowsServer"] ]} }                        
        ],             
        "SecurityGroupIngress" : [                    
          { "IpProtocol" : "tcp", "FromPort" : "3389", "ToPort" : "3389", "CidrIp" : "10.209.220.0/24" },
          { "IpProtocol" : "tcp", "FromPort" : "3389", "ToPort" : "3389", "CidrIp" : "10.216.220.0/24" },
          { "IpProtocol" : "tcp", "FromPort" : "3389", "ToPort" : "3389", "CidrIp" : "10.216.223.0/24" }          
        ]
      }
    },        
    "SecurityGroupLinuxServer" : {
      "Type" : "AWS::EC2::SecurityGroup",
      "Properties" : {
        "GroupDescription" : "Provides administrator access to Linux hosts",
        "VpcId" : {"Ref" : "VPC"},
        "Tags" : [
          { "Key" : "Name", "Value" : { "Fn::Join" : [ "", [ "SEC-", { "Ref" : "AWS::StackName"}, "-LinuxServer"] ]} }                        
        ],                
        "SecurityGroupIngress" : [
          { "IpProtocol" : "tcp", "FromPort" : "22", "ToPort" : "22", "CidrIp" : "10.209.220.0/24" },
          { "IpProtocol" : "tcp", "FromPort" : "22", "ToPort" : "22", "CidrIp" : "10.216.220.0/24" },
          { "IpProtocol" : "tcp", "FromPort" : "22", "ToPort" : "22", "CidrIp" : "10.216.223.0/24" }           
        ]
      }
    }                          
   },   
   "Outputs" : {
    "Vpc" : {
      "Description" : "Vpc ID",
      "Value" : { "Ref" : "VPC" }
    },    
    "WindowsSecurityGroupId" : {
      "Value" : {"Ref" : "SecurityGroupWindowsServer" }
    },    
    "LinuxSecurityGroupId" : {
      "Value" : {"Ref" : "SecurityGroupLinuxServer" }
    }
   }
   
}
